# Player Command to Console Response Flow

This document describes the WR2 flow from a player entering a command in the in-game input box to seeing the resulting response rendered in the console.

## Scope and Preconditions

- The player has already entered a world and is connected to the game WebSocket (`/ws/game/cmd`).
- The game UI is active (`/game`) and using the shared input component:
  - `frontend/src/components/game/Input.vue`
- Command handling described here is the text-command path (`cmd.text`), which is what the input box uses.

## 1) Input capture and local command shaping

1. Player submits the input form in `frontend/src/components/game/Input.vue`.
2. `onSubmit` builds the outgoing command text:
   - Uses current input text when present.
   - Reuses `last_sent` if submit is empty (except for communication commands such as `chat`, `tell`, `say`, etc.).
3. Keyboard shortcuts can also dispatch commands directly from the same component:
   - Arrow keys map to movement (`north`, `south`, `east`, `west`).
   - Shift+Up/Down maps to `up` / `down`.
4. Input dispatches `store.dispatch("game/cmd", <command>)`.

## 2) Frontend Vuex command action (`game/cmd`)

5. `frontend/src/store/modules/game.ts` action `cmd` receives the command.
6. It performs client-side preprocessing:
   - Focus substitutions (`kill` or some two-token commands may auto-fill focused target).
   - Semicolon splitting (`"look;inv"` becomes sequential silent sub-commands).
   - `quit` special-case sends `system.disconnect`.
7. It creates a local echo message and commits it immediately:
   - `{ type: "cmd.text", text: <cmd>, echo: true }`
   - This appears in the console before backend response arrives.
8. It sends the command over WebSocket via `sendWSMessage`.

## 3) WebSocket transport to backend

9. `sendWSMessage` appends the auth token and transmits JSON on the open gameplay socket.
10. FastAPI endpoint `fastapi_app/main.py` routes `/ws/game/cmd` to `fastapi_app/game_ws.py:handle_game_websocket`.
11. For `msg_type == "cmd.text"`, the server queues Celery task `spawns.tasks.handle_game_command` with:
   - `command_type="text"`
   - `player_id` / `player_key`
   - `payload={"text": <cmd>}`
   - `connection_id` (used to prevent stale-connection delivery)

## 4) Celery task and handler dispatch

12. `backend/spawns/tasks.py:handle_game_command` resolves player identity and calls `dispatch_command(...)`.
13. `backend/spawns/handlers/registry.py:dispatch_command`:
   - Loads `Player`.
   - Resolves handler for `command_type`.
   - Builds `CommandContext`.
   - Invokes handler.
14. For text input, `backend/spawns/handlers/text.py:TextCommandHandler`:
   - Parses first token + args.
   - Resolves command using `resolve_text_handler` (prefix match across registered text commands).
   - Maps parsed args into payload fields expected by handlers (`direction`, `target`, `item`, etc.).
   - Delegates to resolved domain handler (`look`, `move`, `drop`, `help`, `/load`, ...).
15. If no handler is found:
   - Builder command (`/something`) => `cmd./something.error`.
   - Non-builder unknown => `cmd.text.echo`.

## 5) Domain logic, events, and message construction

16. Concrete handlers in `backend/spawns/handlers/` call action classes in `backend/spawns/actions/`.
17. Actions return `ActionResult` containing one or more `GameEvent` objects (`backend/spawns/events.py`).
18. Event payload includes:
   - `type` (for example `cmd.look.success`, `cmd.move.success`, `cmd.help.success`)
   - `data` (structured payload for UI state + rendering)
   - optional `text` (pre-rendered lines for console display)
   - `recipients` (one or many players)
19. Many text bodies are generated by `backend/spawns/text_output.py:render_event_text`.

## 6) Publish path back to the client

20. Handlers publish events via `publish_events(...)`.
21. `publish_events` calls `fastapi_app/game_ws.py:publish_to_player`, which publishes into Redis channel `game:pub`.
22. `GameConnectionManager` pub/sub listener in `fastapi_app/game_ws.py` consumes Redis messages and relays them to the active WebSocket.
23. If a `connection_id` is present and does not match the current connection for that player, the message is dropped as stale.

## 7) Frontend receives backend response

24. In `frontend/src/store/modules/game.ts`, `openWebSocket` sets `onmessage` to `receiveMessage`.
25. `receiveMessage` parses JSON and then:
   - Commits `message_add` for most message types (some periodic/utility types are skipped).
   - Updates live state slices (room, map, player, effects, targeting, etc.) based on message `type`.
   - Stores `last_message` and specific tracking pointers like `last_viewed_room_message`.

## 8) Console rendering

26. `frontend/src/components/game/console/Console.vue` reads `store.getters["game/consoleMessages"]`.
27. `game/consoleMessages` filters which messages should appear in console output.
28. For each message, `Console.vue` selects a component by `message.type`:
   - Room-like outputs (`cmd.look.success`, `cmd.move.success`, `cmd.state.sync.success`, etc.) -> `LookRoom.vue`
   - Help output -> `Help.vue`
   - Inventory output -> `Inventory.vue`
   - Combat/chat/etc. -> dedicated components
   - Fallback -> `Message.vue`
29. `Message.vue` renders plain text by splitting `message.text` on newline boundaries.
30. Console autoscroll behavior keeps view pinned to bottom unless the user has intentionally scrolled up.

## Quick Example (`look`)

1. Player submits `look` in `Input.vue`.
2. Frontend echoes `{ type: "cmd.text", text: "look", echo: true }`.
3. Frontend sends `{ type: "cmd.text", text: "look", token: ... }`.
4. Backend resolves `text -> look` and runs `LookAction`.
5. Backend emits `cmd.look.success` with room payload and rendered text.
6. Frontend receives message, updates room/map/player state, and `Console.vue` renders it via `LookRoom.vue`.

## Primary Files In This Flow

- `frontend/src/components/game/Input.vue`
- `frontend/src/store/modules/game.ts`
- `frontend/src/components/game/console/Console.vue`
- `frontend/src/components/game/console/Message.vue`
- `frontend/src/components/game/console/LookRoom.vue`
- `fastapi_app/main.py`
- `fastapi_app/game_ws.py`
- `backend/spawns/tasks.py`
- `backend/spawns/handlers/registry.py`
- `backend/spawns/handlers/text.py`
- `backend/spawns/handlers/base.py`
- `backend/spawns/handlers/information.py`
- `backend/spawns/handlers/movement.py`
- `backend/spawns/events.py`
- `backend/spawns/text_output.py`
